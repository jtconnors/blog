<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Installing Trusted Certificates into a Java Keystore</title>
    <link rel="stylesheet" href="resource/css/entry.css">
  </head>
  <body>
    <big><big><b>Installing Trusted Certificates into a Java Keystore</b></big><br>
      <small><small>By Jim Connors 16 November 2015</small></small><br>
    </big><br>
    As software environments continue to ratchet up security measures,
    the odds of having to deal with digital certificates in more than a
    superficial manner only increases over time.&nbsp; Furthermore,
    platforms are not only mandating the use of certificates, they are
    to a greater extent shunning the self-signed variety and instead
    insisting upon certs that originate from a trusted authority.&nbsp;
    When managing certificates in the Java world, the utility you're
    most likely to encounter is <a
href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html"><tt>keytool</tt>,</a>
    an integral part of the Java Development Kit.&nbsp; Although <tt>keytool</tt>
    can be effectively used to generate self-signed private/public key
    pairs, it's a little lacking when it comes to incorporating in certs
    generated by trusted authorities.&nbsp; <i>[Based upon feedback and
      recommendations received after the original posting of this
      article, a </i><b>Postscript</b><i> section has been appended
      which discusses alternative solutions to the original discussed
      below]</i><br>
    <p>In particular, we'll focus on overcoming the following two
      shortcomings:<br>
    </p>
    <ol>
      <li>An existing private key and certificate generated by a trusted
        Certificate Authority (CA) cannot be imported by <tt>keytool</tt>,
        at least not in the format traditionally provided by CAs.<br>
      </li>
      <li>Not only must the unique private key be imported into the
        keystore, in some instances the root CA certificate and any
        intermediate certificates (referred to as a certificate chain)
        must be included, and more importantly <b><i>in the correct
            order</i></b>.&nbsp; The <tt>keytool</tt> utility doesn't
        help much in the way of ensuring a valid order.</li>
    </ol>
    <p>The following example uses a real SSL certificate chain from a
      real certificate authority and was done in the context of the <a
href="http://www.oracle.com/technetwork/java/javaseproducts/advanced-mgmt/advancedmanagementconsole-2254207.html">Java



        Advanced Management Console</a> 2.1 application.&nbsp; Java AMC
      is a Java EE application and requires <a
href="http://www.oracle.com/technetwork/middleware/weblogic/overview/index-085209.html">Oracle's



        WebLogic</a> application server to function.&nbsp; In this
      instance we'll be updating a keystore associated with WebLogic,
      but in reality this Java keystore should be no different from any
      other Java keystore, so these steps should apply elsewhere just
      fine.</p>
    <p>We'll leave the minutiae of applying for a trusted certificate as
      an exercise for the reader; one of the first steps towards getting
      a certificate involves creating and submitting a CSR (Certificate
      Signing Request) to a Certificate Authority.&nbsp; A byproduct of
      this process is that a private key file is generated based on the
      information in the CSR.&nbsp; This file, when opened, looks
      something like this:</p>
    <blockquote><tt>-----BEGIN PRIVATE KEY-----<br>
        encryptedgobbledygook line 1<br>
        ...<br>
        encryptedgobbledygook line n<br>
        -----END PRIVATE KEY-----</tt><br>
    </blockquote>
    <p>This private key file is in <a
href="https://en.wikipedia.org/wiki/X.509#Certificate_filename_extensions">PEM</a>
      (Privacy Enhanced Mail) format, and will take a <tt>.pem</tt>
      suffix.&nbsp; For our example, the file is stored as:</p>
    <ul>
      <li><b><tt>private-key.pem</tt></b><br>
      </li>
    </ul>
    <p>For this article, we used <a href="https://www.comodo.com/">Comodo</a>
      (one of many alternatives) as our Certificate Authority.&nbsp;
      When the entire process with Comodo was complete, the following
      documents were ultimately received from them:</p>
    <ul>
      <li><b><tt>amc-server_jtconnors_com.crt</tt></b> - This is the
        Comodo-generated host-specific SSL certificate for a machine
        with a Fully Qualified Domain Name (FQDN) of <tt>amc-server.jtconnors.com</tt><br>
      </li>
      <li><b><tt>AddTrustExternalCARoot.crt</tt></b> - Comodo Root
        Certificate<br>
      </li>
      <li><b><tt>COMODORSAAddTrustCA.crt</tt></b> - Comodo Intermediate
        Certificate 1<br>
      </li>
      <li><b><tt>COMODORSADomainValidationSecureServerCA.crt</tt></b> -
        Comodo Intermediate Certificate 2</li>
    </ul>
    <p> With these files in place we can now begin the importing
      process.&nbsp; We will take advantage of enhancements added to <tt>keytool</tt>
      with the Java 6 release: namely that <tt>keytool</tt> can merge
      and import keystores that are in <a
        href="https://en.wikipedia.org/wiki/PKCS_12">PKCS12</a> format.<br>
    </p>
    <p>With this new information what remains is to figure out how to
      convert our private key and certificate chain into a PKCS12
      file.&nbsp; For this functionality we resort to the capabilities
      found in the ubiquitous <a href="http://www.openssl.org/">OpenSSL</a>
      toolkit, available on virtually all popular compute
      platforms.&nbsp; In the example that follows, we'll be running on
      a Windows system and will utilize the <a
        href="https://www.cygwin.com/">Cygwin</a> environment to run the
      required OpenSSL commands.<br>
      <tt><tt> </tt></tt></p>
    <tt><tt> </tt></tt>
    <blockquote> </blockquote>
    <p>Step 1. (From Cygwin) Concatenate the certificates comprising the
      CA-supplied root certificate chain to one file.&nbsp; Include only
      the root certificate and intermediate certificate(s) and exclude
      the host-specific SSL certificate.</p>
    <blockquote> </blockquote>
    <blockquote>
      <p><b><tt>$ cat AddTrustExternalCARoot.crt COMODORSAAddTrustCA.crt
            COMODORSADomainValidationSecureServerCA.crt &gt; BUNDLE.crt</tt></b></p>
    </blockquote>
    <blockquote> </blockquote>
    <p>Step 2. (From Cygwin) Create a PKCS12 keystore.&nbsp; This
      command incorporates both the certificate chain along with the SSL
      private key and certificates.&nbsp; Your passwords may vary.<br>
    </p>
    <blockquote> </blockquote>
    <blockquote>
      <p><b><tt>$ openssl pkcs12 -export -chain -in
            amc-server_jtconnors_com.crt -inkey private-key.pem -out
            keystore.p12 -name amc-server -CAfile BUNDLE.crt<br>
            Enter Export Password: </tt></b><tt>changeit</tt><b><tt><br>
            Verifying - Enter Export Password: </tt></b><tt>changeit</tt><br>
      </p>
    </blockquote>
    <p>Step 3. (From Windows CMD) Using <tt>keytool</tt>, import the
      PKCS12 keystore into the resulting JKS keystore called <tt>keystore.jks</tt>.
      Again, you may select different passwords.<br>
    </p>
    <blockquote>
      <p><b><tt>&gt; "c:\Program Files\Java\jdk1.8.0_66\bin\keytool.exe"
            -importkeystore -destkeystore keystore.jks -srckeystore
            keystore.p12 -alias amc-server<br>
            Enter destination keystore password: </tt></b><tt>changeit</tt><b><tt><br>
            Re-enter new password: </tt></b><tt>changeit</tt><b><tt><br>
            Enter source keystore password: </tt></b><tt>changeit</tt><br>
      </p>
    </blockquote>
    <p>Step 4. With the keystore successfully created we can now take
      the optional step of further verifying it.&nbsp; Certain
      Java-based application frameworks, like Oracle's WebLogic for
      example, can be finicky about the completeness and order of the
      certificate chain.&nbsp; To help validate the keystore, we can use
      the <tt>ValidateCertChain</tt> program which comes bundled with
      WebLogic 12c and can be found in the distribution's <tt>weblogic.jar</tt>
      file.&nbsp; Here's a sample invocation of the program on our
      recently created <tt>keystore.jks</tt> file:</p>
    <blockquote>
      <p><b><tt>&gt; java -cp %MW_HOME%\wlserver\server\lib\weblogic.jar
            utils.ValidateCertChain -jks amc-server keystore.jks<br>
            Cert[0]:
            CN=amc-server.jtconnors.com,OU=PositiveSSL,OU=Domain Control
            Validated<br>
            Cert[1]: CN=COMODO RSA Domain Validation Secure Server
            CA,O=COMODO CA Limited,L=Salford,ST=Greater Manchester,C=GB<br>
            Cert[2]: CN=COMODO RSA Certification Authority,O=COMODO CA
            Limited,L=Salford,ST=Greater Manchester,C=GB<br>
            Cert[3]: CN=AddTrust External CA Root,OU=AddTrust External
            TTP Network,O=AddTrust AB,C=SE<br>
            Certificate chain appears valid</tt></b></p>
    </blockquote>
    <p> </p>
    <p>Here's hoping these examples save you some time, and more
      importantly, a little grief.<br>
    </p>
    <p><b>Postscript</b></p>
    <p>After having received recommendations from the engineers far
      better versed in AMC and WebLogic, the following section was added
      to briefly discuss alternatives to the above mentioned OpenSSL
      solution.</p>
    <p> </p>
    <p><b>Alternative A</b>:&nbsp; For people that have complete control
      of the certificate generating process, they can, as previously
      hinted, use <tt>keytool</tt> exclusively for this process. For
      the first phase of the process they can use <tt>keytool</tt> in
      the following general manner (arguments to <tt>keytool</tt> will
      vary) to generate a keypair and certificate request:</p>
    <blockquote>
      <p><b><tt>keytool -keystore keystore.jks -genkeypair -keyalg rsa <br>
            keytool -keystore keystore.jks -certreq</tt></b> </p>
    </blockquote>
    <p>In this scenario, OpenSSL would not be required since the keypair
      is already stored in the keystore.&nbsp; From here you can import
      the certificates following a form similar to this:</p>
    <blockquote>
      <p><b><tt>keytool -import -keystore keystore.jks -alias root -file
            AddTrustExternalCARoot.crt <br>
            keytool -import -keystore keystore.jks -alias intermediate1
            -file COMODORSAAddTrustCA.crt <br>
            keytool -import -keystore keystore.jks -alias intermediate2
            -file COMODORSADomainValidationSecureServerCA.crt <br>
            keytool -import -keystore keystore.jks -alias mykey -file
            amc-server_jtconnors_com.crt</tt></b></p>
    </blockquote>
    <p>In the last command, "<tt>-alias mykey</tt>" is essential and
      must match the key pair in the keystone.&nbsp; As a shortcut, you
      could also concatenate all PEM-encoded certificates into a big
      file and then call: </p>
    <blockquote>
      <p><b><tt>keytool -import -keystore keystore.jks -alias mykey
            -file thebigfile</tt></b> </p>
    </blockquote>
    <p><b>Alternative B</b>: Along with the <tt>ValidateChain</tt>
      program WebLogic 12c's <tt>weblogic.jar</tt> file also includes a
      utility called <tt>ImportPrivateKey</tt> which can also used to
      import a certificate chain into a Java keystore.&nbsp; This
      utility command is described in <a
href="http://docs.oracle.com/middleware/1213/wls/SECMG/identity_trust.htm#SECMG791">Creating




        a Keystore Using ImportPrivateKey</a> subsection of WebLogic
      documention on <a
href="http://docs.oracle.com/middleware/1213/wls/SECMG/identity_trust.htm">Configuring




        Keystores</a>.&nbsp; The command follows a form like this:</p>
    <blockquote>
      <pre style="font-family: Consolas,monospace; font-size: inherit; white-space: pre-wrap;"><b><tt>java -cp %WL_HOME%\server\lib\weblogic.jar utils.ImportPrivateKey -keystore <i>newkeystore</i> -storepass <i>**keystorepassword** </i> -alias <i>amctrust</i> -certfile <i>certificate.pem </i> -keyfile <i>privatekey.pem</i> [-keyfilepass <i>**privatekeypassword**</i>]</tt></b></pre>
    </blockquote>
    <p> </p>
    <p>For further edification please consult the WebLogic docs.<br>
    </p>
    <div class="footer"><a href="index.html">Index</a></div>
    <p> </p>
    <p><br>
    </p>
    <br>
  </body>
</html>
